<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">    
    <script src="../../facturacion/js/sweetalert2.all.min.js"></script>
    <link href="../../facturacion/css/sweetalert2.min.css" rel="stylesheet" />    
    <script src="../auxiliares.js"></script>       
    <script src="../../facturacion/js/bootstrap.bundle.min.js"></script>
    <link href="../../facturacion/css/bootstrap.min.css" rel="stylesheet" />
    <title>Reportes Retenciones - SIAC</title>
</head>
<header id="encabezado"></header>
<style>
     .table-container {
        height: 500px;
        overflow-y: auto;
        position: relative;
    }
    
    .table thead th {
        position: sticky;
        top: 0;
        background: #212529;
        color: white;
        z-index: 100;
        vertical-align: middle;
        border-bottom: 2px solid #32383e;
    }
    @media print{       
        td{
            padding: .2rem!important;
            font-size: smaller!important;
        }        
    }
</style>
<div class="d-print-none" style="padding: .375rem .75rem !Important;position: fixed;
    top: 2.5em;
    right: 0;z-index:1022">
    <button type="button" class="btn btn-success " id="cargarExcel" >Excel</button>
    <button type="button" class="btn btn-secondary disabled" id="cargarTxt" 
        data-bs-toggle="tooltip" data-bs-placement="top"
        data-bs-custom-class="custom-tooltip"
        data-bs-title="Prepara el archivo txt para declarar IVA a traves del portal SENIAT">TXT</button>
    
</div>
<body class="container-xl">
    <div class="d-flex justify-content-center">
        <div class="row ">
            <h4 class="">Relacion de retenciones <span id="titulo">IVA</span></h4>
        </div>
    </div>
    <div class="row filtros">
        <div class="col-2">
            <div class="form-check">
                        <input id="chkIva" 
                            class="form-check-input tipoReporte" 
                            data-campo="I.V.A."
                            type="radio" name="tipoReporte" value="iva" checked >
                        <label class="form-check-label" for="chkIva">
                            IVA
                        </label>
                    </div>
                    <div class="form-check">
                        <input id="chkIslr"
                            class="form-check-input tipoReporte" 
                            data-campo="I.S.L.R."
                            type="radio" name="tipoReporte"  value="islr" >
                        <label class="form-check-label" for="chkIslr">
                            ISLR
                        </label>
                    </div>
        </div>
        <div class="col-4 form-floating mb-1">
            <select
            class="form-select form-select"
            aria-label=".form-select-sm example"
            id="id_proveedor"
            ></select>
            <label for="id_proveedor" class="form-label  ms-1">Proveedor</label>
        </div>
        <div class="form-floating mb-1 col-2">
                <input type="date" class="form-control cambio_filtro" id="fecha_ini"> 
                <label for="fecha_ini" class="form-label  ms-1">Desde</label>
            </div>
            <div class="form-floating mb-1 col-2">
                <input type="date" class="form-control cambio_filtro" id="fecha_fin"> 
                <label for="fecha_fin" class="form-label  ms-1">Hasta</label>
            </div>
            <div class="mb-1 col-2  d-print-none">
                <button type="button" class="btn btn-primary" id="filtrar">Buscar</button>                
            </div>
    </div>
    
   
        <div id="tablaContenedor"></div>
    
</body>
</html>
<script>    

    const params = new URLSearchParams(window.location.search);
    const token = params.get("token");
    window.configs_token = [];
    
    if (token) {
        
      localStorage.setItem("token", token);
      
      get_config_token()
      
    }

    function get_config_token () {
        const token = localStorage.getItem("token");

        fetch(`https://pruebas.siac.historiaclinica.org/decodifica`, {
          method: "GET",
          headers: {
              Authorization: `Bearer ${token}`,
          },
        })
        .then((response) => response.json())
        .then((data) => {            
            configs_token = data;
            cargar_header()
            cargar_proveedores()
            const currentTime = Math.floor(Date.now() / 1000); // Current time in seconds
            const expirationTime = configs_token.exp; // Expiration time in seconds
            const timeRemaining = expirationTime - currentTime;
      
            if (timeRemaining <= 0) {
                console.log("Token has already expired.");
                window.location.href = 'https://siac.empresas.historiaclinica.org/login.php'
                return;
              }
        })        
            return configs_token;
    }



    document.addEventListener('DOMContentLoaded', function() {
        
    })
    async function cargar_header() {
        fetch(`https://pruebas.siac.historiaclinica.org/api/header/${configs_token.id_cli}`, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',            
        }        
    })
    .then(response => response.json())
    .then(result => {
        document.getElementById('encabezado').innerHTML=result.html
         const style = document.createElement('style');
        style.id = 'estilos-cabecera';    
        const cssContent = result.estilos
            .replace(/<\/?styles?>/gi, '') // Elimina <styles> y </styles>
            .trim();
        style.textContent = cssContent;
        document.head.appendChild(style); 
    })
    }
    let data_txt=[];
document.querySelectorAll('.tipoReporte').forEach(checkInput => {
    checkInput.addEventListener('change', function(){
        document.getElementById('tablaContenedor').innerHTML=''
        data_txt=[];
        document.getElementById('titulo').innerText=this.value.toUpperCase()
           const cargarTxtButton = document.getElementById('cargarTxt');
            if (this.value === "islr") {
                cargarTxtButton.classList.add('disabled');
            } else {
                cargarTxtButton.classList.remove('disabled');
            }
    })
})

function toDateInputValue(dateObject){
    const local = new Date(dateObject);
    local.setMinutes(dateObject.getMinutes() - dateObject.getTimezoneOffset());
    return local.toJSON().slice(0,10);
};

const fecha = new Date();
const year = fecha.getFullYear();
const month = String(fecha.getMonth() + 1).padStart(2, '0');

document.getElementById("fecha_ini").value = `${year}-${month}-01`;
document.getElementById("fecha_fin").value = toDateInputValue(new Date());

async function cargar_proveedores() {
    var id_cli = configs_token.id_cli
    try{
        const responseProveedores = await fetch(`https://pruebas.siac.historiaclinica.org/api/control_gastos/proveedores?id_cli=${id_cli}`);
        const dataProveedores = await responseProveedores.json();
                 
            if (dataProveedores.success) {
                proveedores = dataProveedores.data;       
                const selectProveedor = document.getElementById('id_proveedor');
                                    
                // Limpiar select
                selectProveedor.innerHTML = '<option value="">TODOS</option>';
                
                // Llenar select
                proveedores.forEach(proveedor => {
                    if (proveedor.activo) {
                        const option = document.createElement('option');
                        option.value = proveedor.id_proveedor;
                        option.textContent = proveedor.nombre;
                        selectProveedor.appendChild(option);
                    }
                });
          
        }
                        
    } catch (error) {
        console.error('Error al cargar selects:', error);
        mostrarAlerta('Error al cargar los datos de categorías y proveedores', 'danger');
    }
}


function tabletoExcel(tableID, filename = 'SIAC-retenciones') {
    // Obtener la tabla
    var table = document.getElementById(tableID);
    
    // Crear documento HTML con codificación UTF-8
    var html = `
    <html xmlns:o="urn:schemas-microsoft-com:office:office" 
          xmlns:x="urn:schemas-microsoft-com:office:excel" 
          xmlns="http://www.w3.org/TR/REC-html40">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <!--[if gte mso 9]>
        <xml>
            <x:ExcelWorkbook>
                <x:ExcelWorksheets>
                    <x:ExcelWorksheet>
                        <x:Name>${filename || 'Datos'}</x:Name>
                        <x:WorksheetOptions>
                            <x:DisplayGridlines/>
                        </x:WorksheetOptions>
                    </x:ExcelWorksheet>
                </x:ExcelWorksheets>
            </x:ExcelWorkbook>
        </xml>
        <![endif]-->
    </head>
    <body>
        ${table.outerHTML}
    </body>
    </html>`;
    
    // Codificar correctamente el contenido
    var blob = new Blob([html], {
        type: 'application/vnd.ms-excel;charset=UTF-8'
    });
    
    // Crear enlace de descarga
    var link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = (filename || 'datos') + '.xls';
    link.style.visibility = 'hidden';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

document.getElementById('filtrar').addEventListener('click', function (){
    const tipo = document.querySelector('input[name="tipoReporte"]:checked').value;
    realizarBusqueda(tipo)
})

async function realizarBusqueda(tipo, paginaActual=1) {    
    var id_cli=configs_token.id_cli
    try {
        // Construir parámetros de búsqueda
        const params = new URLSearchParams();
        var id_proveedor = document.getElementById('id_proveedor').value
        if(!id_proveedor==''){
            params.append('proveedor_id', id_proveedor);
        }        
        params.append('fecha_desde', document.getElementById('fecha_ini').value);
        params.append('fecha_hasta', document.getElementById('fecha_fin').value);
        params.append('id_cli', id_cli);
        params.append('page', paginaActual);
        params.append('limit', 500);

        const response = await fetch(`https://facturacion.siac.historiaclinica.org/api/retenciones/${tipo}?${params}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem("token")}`
            }
        });

        const data = await response.json();

        if (data.success) {
            
            mostrarTablaRetenciones(data, tipo, 'tablaContenedor');
            if(data.pagination.totalPages>1){
                Swal.fire({
                    title: 'Atencion',
                    text: 'Los resultados son muy grandes, solo se muestra los primeros 500 registros, acorte las fechas o incluya solo un proveedor a la vez',
                    icon: 'warning',
                    confirmButtonColor: '#3085d6',                    
                    confirmButtonText: 'Aceptar'
                })
                    
                    
            }
        } else {
            throw new Error(data.error || 'Error en la búsqueda');
        }

    } catch (error) {
        console.error('Error en búsqueda:', error);
        Swal.fire({
            title: 'Error',
            text: 'No se pudo realizar la búsqueda: ' + error.message,
            icon: 'error',
            confirmButtonText: 'Ok'
        });
        mostrarMensajeInicial();
    }
}

function crearTablaRetenciones(data, tipo) {
    // Determinar si es ISLR o IVA
    const esISLR = tipo === 'islr' || (data.data && data.data[0] && data.data[0].tipo_retencion !== undefined);
    
    // Definir columnas según el tipo
    const columnas = esISLR ? [
        { key: 'numero_comprobante', title: 'N° Comprobante' },
        { key: 'fecha_operacion', title: 'Fecha Operación' },
        { key: 'proveedor_nombre', title: 'Proveedor' },
        { key: 'proveedor_rif', title: 'RIF' },
        { key: 'doc_num', title: 'N° Documento' },
        { key: 'control_num', title: 'N° Control' },
        { key: 'monto_sujeto', title: 'Monto Sujeto', type: 'number' },
        { key: 'total_ut', title: 'Total UT', type: 'number' },
        { key: 'total_retener', title: 'Total a Retener', type: 'number' },
        { key: 'total_pagar', title: 'Total a Pagar', type: 'number' }
    ] : [
        { key: 'numero_comprobante', title: 'N° Comprobante' },
        { key: 'fecha_retencion', title: 'Fecha Retención' },
        { key: 'proveedor_nombre', title: 'Proveedor' },
        { key: 'proveedor_rif', title: 'RIF' },
        { key: 'numero_documento', title: 'N° Documento' },
        { key: 'numero_control', title: 'N° Control' },
        { key: 'base_imponible', title: 'Base Imponible', type: 'number' },        
        { key: 'total_iva', title: 'Total IVA', type: 'number' },        
        { key: 'total_iva_retenido', title: 'IVA Retenido', type: 'number' },
        { key: 'total_documento', title: 'Total Documento', type: 'number' }
    ];

    // Crear contenedor de la tabla
    const container = document.createElement('div');
    container.className = 'table-responsive';
    
    // Crear tabla
    const table = document.createElement('table');
    table.className = 'table table-striped table-bordered table-hover';
    
    // Crear encabezado
    const thead = document.createElement('thead');
    thead.className = 'table-dark';
    const headerRow = document.createElement('tr');
    
    columnas.forEach(col => {
        const th = document.createElement('th');
        th.textContent = col.title;
        th.style.textAlign = col.type === 'number' ? 'right' : 'left';
        headerRow.appendChild(th);
    });
    
    thead.appendChild(headerRow);
    table.appendChild(thead);
    
    // Crear cuerpo de la tabla
    const tbody = document.createElement('tbody');
    
    let currentProveedor = null;
    let subtotal = {};
    const totalGeneral = {};
    
    // Inicializar totales
    columnas.forEach(col => {
        if (col.type === 'number') {
            totalGeneral[col.key] = 0;
        }
    });
    let contador =1
    let contadorTotal=0;

    // Filtrar los datos para incluir solo los activos
    const datosActivos = data.data.filter(item => item.activo === 1);
    data_txt=datosActivos;
    // Procesar datos
    datosActivos.forEach((item, index) => {
        // Verificar cambio de proveedor
        contadorTotal++
        if (currentProveedor !== item.proveedor_id) {
            
            // Insertar subtotal del proveedor anterior
            if (currentProveedor !== null) {
                insertarFilaResumen(tbody, subtotal, `Subtotal ${currentProveedorNombre}`, columnas, true, contador, contadorTotal);
            }
            
            // Reiniciar subtotal para nuevo proveedor
            currentProveedor = item.proveedor_id;
            currentProveedorNombre = item.proveedor_nombre;
            contador =0;
            subtotal = {};
            columnas.forEach(col => {
                if (col.type === 'number') {
                    subtotal[col.key] = 0;
                }
            });
        }
        
        contador++
        // Crear fila de datos
        const row = document.createElement('tr');
        
        columnas.forEach(col => {
            const td = document.createElement('td');
            
            if(col.key === 'numero_comprobante') {
                td.classList.add('text-nowrap')
            }
            
            if (col.type === 'number') {
                const value = parseFloat(item[col.key]) || 0;
                td.textContent = value.toLocaleString('es-VE', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                td.style.textAlign = 'right';
                
                // Acumular subtotales y total general
                subtotal[col.key] += value;
                totalGeneral[col.key] += value;
            } else {
                // Formatear fechas
                if (col.key.includes('fecha')) {
                    const fecha = new Date(item[col.key]);
                    td.textContent = fecha.toLocaleDateString('es-VE');
                } else {
                    td.textContent = item[col.key] || '';

                    if(col.key === 'proveedor_nombre') {
                        var proveedor = item[col.key];
                        
                        if (proveedor.length > 18) {
                            td.classList.add('text-nowrap')
                            proveedor= proveedor.substring(0, 16) + '...';
                        }
                        td.textContent =proveedor
    
                    }
                }
                td.style.textAlign = 'left';
            }
            
            row.appendChild(td);
        });
        
        tbody.appendChild(row);
        
        // Insertar subtotal después del último registro
        if (index === datosActivos.length - 1) {
            insertarFilaResumen(tbody, subtotal, `Subtotal ${currentProveedorNombre}`, columnas, true, contador, contadorTotal);
        }
    });
    
    // Insertar total general
    insertarFilaResumen(tbody, totalGeneral, 'TOTAL GENERAL', columnas, false, contador, contadorTotal);
    
    table.appendChild(tbody);
    container.appendChild(table);
    
    return container;
}

function insertarFilaResumen(tbody, datos, texto, columnas, esSubtotal, cantidad, cantidadTotal) {

    const row = document.createElement('tr');
    row.className = esSubtotal ? 'table-info' : 'table-success fw-bold';
    
    columnas.forEach((col, index) => {
        
        const td = document.createElement('td');
        
        if (index === 1) { // Columna del proveedor para el texto del resumen
            td.textContent = texto;
            td.style.fontWeight = 'bold';
            td.colSpan = 4; // Ocupa múltiples columnas
        
        }
        if(index===5){
            td.textContent = esSubtotal ? cantidad: cantidadTotal;
            td.style.fontWeight = 'bold';
            td.classList.add('text-center')
        }
        
        if (col.type === 'number' && datos[col.key] !== undefined) {
            td.textContent = datos[col.key].toLocaleString('es-VE', { 
                minimumFractionDigits: 2, 
                maximumFractionDigits: 2 
            });
            td.style.textAlign = 'right';
            td.style.fontWeight = 'bold';
        }
        if (index == 2||index == 3||index == 4 ) {
                
            }else{
                row.appendChild(td);
            }
       
        
    });
    
    tbody.appendChild(row);
}
 
function mostrarTablaRetenciones(data, tipo, contenedorId) {
    const contenedor = document.getElementById(contenedorId);
    if (!contenedor) {
        console.error('Contenedor no encontrado');
        return;
    }
    
    contenedor.innerHTML = '';
    const tabla = crearTablaRetenciones(data, tipo);
    contenedor.appendChild(tabla);
}

document.getElementById('cargarExcel').addEventListener('click', function() {
    tabletoExcel('tablaContenedor')
})

function generarArchivoTSV(data) {
    const filas = data.map(item => {
        // --- Procesar fecha ---
        const fechaRetencion = new Date(item.fecha_retencion);
        const year = fechaRetencion.getFullYear();
        const month = fechaRetencion.getMonth() + 1;
        const periodoImpositivo = `${year}${String(month).padStart(2, '0')}`; // 202509

        const fechaDocumento = item.fecha_retencion ? item.fecha_retencion.split('T')[0] : '0000-00-00';

        // --- Tipo Operación ---
        const tipoOperacion = (item.tipo ? item.tipo.charAt(0).toUpperCase() : '0');

        // --- Tipo Documento ---
        const tipoDocumentoMap = { 1: '01', 2: '02', 3: '03' };
        const tipoDocumento = tipoDocumentoMap[item.id_tipo_documento] || '01';

        // --- RIFs ---
        const rif = item.proveedor_rif || '0';
        const numAfectado = item.numero_afectado === "0" || !item.numero_afectado ? '0' : item.numero_afectado;

        // --- Número de comprobante limpio ---
        let compClean = '0'.repeat(14);
        if (item.numero_comprobante) {
            compClean = item.numero_comprobante.replace(/-/g, '');
            if (compClean.length < 14) {
                compClean = compClean.padEnd(14, '0');
            } else {
                compClean = compClean.substring(0, 14);
            }
        }

        // --- Formateo de montos: si es 0, null, undefined → '0.00' ---
        const formatNumber = (value) => {
            const num = parseFloat(value);
            return isNaN(num) ? '0.00' : num.toFixed(2);
        };

        const montoDocumento = formatNumber(item.total_documento);
        const baseImponible = formatNumber(item.base_imponible);
        const montoIVA = formatNumber(item.total_iva);
        const montoExento = formatNumber(item.total_exento);
        const alicuota = formatNumber(item.alicuota);

        // --- Número de expediente ---
        const numExpediente = item.numero_expediente === "0" || !item.numero_expediente ? '0' : item.numero_expediente;

        // --- Lista de campos finales (todos deben tener valor) ---
        const campos = [
            rif,                        // RIF_Contribuyente
            periodoImpositivo,          // Periodo_Impositivo
            fechaDocumento,             // Fecha_Documento
            tipoOperacion,              // Tipo_Operacion
            tipoDocumento,              // Tipo_Documento
            rif,                        // RIF_Comprador_Vendedor
            item.numero_documento || '0',           // Numero_Documento
            item.numero_control || '0',             // Numero_Control_Documento
            montoDocumento,             // Monto_Documento
            baseImponible,              // Base_Imponible
            montoIVA,                   // Monto_IVA
            numAfectado,                // Numero_Documento_Afectado
            compClean,                  // Numero_Comprobante
            montoExento,                // Monto_Exento_IVA
            alicuota,                   // Alicuota
            numExpediente               // Numero_Expediente
        ];

        // Reemplazar cualquier valor vacío o nulo por "0"
        const camposRellenos = campos.map(campo => {
            // Convertimos a string para verificar
            const str = String(campo).trim();
            return str === '' || str === 'null' || str === 'undefined' || str === 'NaN' ? '0' : str;
        });

        // Devolver fila como string separado por tabulaciones
        return camposRellenos.join('\t');
    });

    // Unir todas las filas con salto de línea
    return filas.join('\n');
}

document.getElementById('cargarTxt').addEventListener('click', function() {
    const contenido = generarArchivoTSV(data_txt);
    descargarTXT(contenido)
})

function descargarTXT(contenido) {
    let fechaStr = document.getElementById('fecha_ini').value;
    let fecha = new Date(fechaStr);
    let year = fecha.getFullYear();
    let month = fecha.getMonth() + 1;
    let fecha_nombre = `${year}${month.toString().padStart(2, '0')}`;

    let empresa = document.querySelector('.nombre_empresa').textContent.trim();
    let nombre = `Relación de Facturas ${fecha_nombre} ${empresa}.txt`;
    const blob = new Blob([contenido], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = nombre;
    a.click();
    URL.revokeObjectURL(url);
}

document.getElementById('id_proveedor').addEventListener('change', function() {
    const cargarTxtButton = document.getElementById('cargarTxt');
    if (this.value === "" || this.value === "0")  {
        cargarTxtButton.classList.add('disabled');
    } else {
        if(document.getElementById('chkIslr').checked==true){
            cargarTxtButton.classList.add('disabled');
        }else{
            cargarTxtButton.classList.remove('disabled');
        }
    }
    
});

const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))


</script>
<script src="../../facturacion/js/bootstrap.bundle.min.js"></script>
<link href="../../facturacion/css/bootstrap.min.css" rel="stylesheet" />    
