<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facturas - SIAC</title>
    <link rel="icon" type="image/x-icon" href="https://siac.empresas.historiaclinica.org/images/Imagen1.ico">
    <script src="https://siac.empresas.historiaclinica.org/js/sweetalert2.all.min.js"></script>
    <link href="https://siac.empresas.historiaclinica.org/css/sweetalert2.min.css" rel="stylesheet" />
    <script src="https://siac.empresas.historiaclinica.org/js/bootstrap.bundle.min.js"></script>
    <link href="https://siac.empresas.historiaclinica.org/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://siac.empresas.historiaclinica.org/js/jquery-3.7.1.js"></script>
    <script src="https://siac.empresas.historiaclinica.org/js/lordicon.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
</head>
<style>
    .botonera{
        gap:10px;
    }
   .svg.disk_save.botonera{
        outline: gray 1px solid;
        border-radius: 3px;
    }
    #pacientes{
        height: 33px;
    }
    .svg.disk_save.botonera:hover{
        outline-color: aliceblue;
        outline-width: 3px;
        outline-style: ridge;
        border-radius: 3px;
        background-color: aliceblue;
    }
    .svg.disk_save.botonera{
        cursor: pointer;
    }
    .tabla-admisiones{
        max-height: 300px;
        overflow-y: scroll;
    }
    thead {
        position: sticky;
        top: 0;
    }
    .div1 {
        grid-area: 1 / 1 / 2 / 2;
    }

    .div2 {
        grid-area: 1 / 2 / 2 / 4;
    }
    .filtros_div {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        grid-template-rows: 1fr;
        grid-column-gap: 0px;
        grid-row-gap: 0px;
    }
    input[readonly] {
        background-color: #f0f0f0;
        border: 1px solid #ccc;
        color: #333;
    }
    textarea[readonly] {
        background-color: #f0f0f0;
        border: 1px solid #ccc;
        color: #333;
    }
    input[type="text"] {
        width: 100%;
        padding: 2px;
        border-radius: 4px;
        border: 1px solid #ccc;
    }
    textarea {
        width: 100%;
        padding: 2px;
        height: 68px;
        border-radius: 4px;
        border: 1px solid #ccc;
    }
    
    @media (min-width: 576px) {
        .modal-dialog {
            max-width: 800px !important;
            margin: 1.75rem auto;
        }
    }
</style>
<body>
    <div class="container">        
        <h2>Facturaci贸n SIAC</h2>
        <div class="row">
            <div class="col-8 rounded-1 border border-1 border-info-subtle">
                <div class="row mb-1 mt-1">
                    <div class="col-2"><span class="text-nowrap">Razon Social</span></div>
                    <div class="col-10"><input type="text" id="razon_social" readonly/> </div>
                </div>
                <div class="row mb-1 ">
                    <div class="col-2"><span>RIF</span></div>
                    <div class="col-10"><input id="rif" type="text" readonly/> </div>
                </div>
                <div class="row ">
                    <div class="col-2"><span>Direcci贸n Fiscal</span></div>
                    <div class="col-10"><textarea id="dir_fiscal" readonly></textarea> </div>
                </div>
                <div class="row">
                    <div class="col-2"><span>Paciente(s)</span></div>
                    <div class="col-10"><textarea type="text" id="pacientes"  readonly></textarea></div>
                </div>
                
            </div>
            <div class="col-4 rounded-1 border border-1 border-info-subtle">
                <div class="row mb-1 mt-1">
                    <div class="col-5 text-end"><span>Control</span></div>
                    <div class="col-7"><input type="text" readonly/> </div>
                </div>
                <div class="row mb-1">
                    <div class="col-5 text-end"><span>Factura</span></div>
                    <div class="col-7"><input type="text" readonly/> </div>
                </div>
                <div class="row mb-1">
                    <div class="col-5 text-end"><span>F. Atenci贸n</span></div>
                    <div class="col-7"><input type="text" readonly/> </div>
                </div>
                <div class="row mb-1">
                    <div class="col-5 text-end"><span>F. Emisi贸n</span></div>
                    <div class="col-7"><input type="text" readonly/> </div>
                </div>
                <div class="row mb-1">
                    <div class="col-5 text-end"><span>Formato</span></div>
                    <div class="col-7"><input type="text" readonly/> </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="mt-1 mb-1">   
                <div class="btn-group w-100 " role="group" aria-label="Tipo de factura" data-bs-toggle="tooltip"
                    data-bs-placement="top" title="Formato de agrupacion">
                    <input type="radio" class="btn-check" name=rad_tipo_agrupamiento id="btn_detalle_agrupado"  value="agrupada">
                    <label class="btn btn-outline-primary" for="btn_detalle_agrupado">Por grupo</label>
                    <input type="radio" class="btn-check" name=rad_tipo_agrupamiento id="btn_detalle_tipo"  value="tipo">
                    <label class="btn btn-outline-primary" for="btn_detalle_tipo">Por tipo</label>
                    <input type="radio" class="btn-check" name=rad_tipo_agrupamiento id="btn_detalle_detallado" value="detallada" checked>
                    <label class="btn btn-outline-primary" for="btn_detalle_detallado">Detallada</label>
                    <input type="radio" class="btn-check" name=rad_tipo_agrupamiento id="btn_detalle_porcentual" value="porcentual">
                    <label class="btn btn-outline-primary" for="btn_detalle_porcentual">Porcentual</label>
                </div>
            </div>
            <table class="table table-striped" id="table_detalle"></table>
        </div>
        <div class="row ">
            <div class="col-6">
                <div class="form-floating row">
                    <textarea class="form-control" placeholder="Nota" id="nota"></textarea>
                    <label for="nota">Nota</label>
                </div>
                <div class="row">
                    <div class="form-check form-switch">
                        <input class="form-check-input tasa_chk" type="radio" id="chk_tasa_admision" name='tasa_chk' data-tasa="0.00" checked>
                        <label class="form-check-label" for="chk_tasa_admision">Tasa Admision (<span id="tasa_admi" class="tasa_admi"></span>)</label>
                    </div>
                    <div class="form-check form-switch tasa_chk">
                        <input class="form-check-input " type="radio" id="chk_tasa_actual" name='tasa_chk' >
                        <label class="form-check-label" for="chk_tasa_actual">Tasa Actual</label>
                    </div>
                    <div class="form-check form-switch  tasa_chk">
                        <input class="form-check-input " type="checkbox" id="chk_contado" name='contado' checked>
                        <label class="form-check-label" for="chk_contado">Pago Contado</label>
                    </div>
                    <div class="row row_credito mt-1 d-none">
                        <input type="hidden" id=moneda_credito>
                        <input type="hidden" id=monto_credito>
                        <div class="form-floating col-8">
                            <input type="date" name="fecha_vencimiento" id="fecha_vencimiento"
                            class="fecha_vencimiento form-control form-date border border-primary-subtle" 
                            value='' min='2024-11-01'/>
                            <label for="fecha_vencimiento">Fecha Vencimiento</label>
                        </div>
                        <div class="form-floating col-4 ">
                            <input type="text" class="form-control text-center border border-primary-subtle" 
                            id=cuotas
                            value="" maxlength="2">
                            <label for="cuotas">Cuotas</label>
                            <script>                                               
                                $("#cuotas").on("input", function () {
                                    this.value = this.value.replace(/[^0-9]/g, "").replace(/,/g, ".");
                                });
                            </script>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-6">
                <div class="row">
                    <div class="col-4 text-end"><span>Exento: </span></div>
                    <div class="col-8"><input type="text" readonly/></div>
                </div>
                <div class="row">
                    <div class="col-4 text-end"><span>BI 16:</span></div>
                    <div class="col-8"><input type="text" readonly/></div>
                </div>
                <div class="row">
                    <div class="col-4 text-end"><span>IGFT:</span></div>
                    <div class="col-8"><input type="text" readonly/></div>
                </div>
                <div class="row">
                    <div class="col-4 text-end"><span>IVA(16)</span></div>
                    <div class="col-8"><input type="text" readonly/></div>
                </div>
                <div class="row">
                    <div class="col-4 text-end"><span>Total:</span></div>
                    <div class="col-8"><input type="text" readonly/></div>
                </div>
            </div>
        </div>
        <div class="botonera d-flex justify-content-center align-items-center flex-row mt-1">
            
            <div data-bs-toggle="modal" data-bs-target="#modal_admisiones" id="agregar_admi">
                <lord-icon src="../images/wired-lineal-48-plus-to-square-rotation.json"
                    trigger="hover" style="width:70px;height:70px" class="svg disk_save  botonera" data-bs-toggle="tooltip"
                    data-bs-placement="top" title="Agregar admisiones" data-bs-toggle="modal" data-bs-target="#staticBackdrop">
                </lord-icon>
    
            </div>
    
            <div id="div_fact_factura">
                <lord-icon id="btn_fact_factura" src="../images/wired-lineal-1374-cash-register-messenger.json"
                    trigger="hover" style="width:70px;height:70px" class="svg disk_save  botonera" data-bs-toggle="tooltip"
                    data-bs-placement="top" title="Factura" data-bs-toggle="modal" data-bs-target="#staticBackdrop">
                </lord-icon>
            </div>
            
            <div id="div_imprimir">
                <lord-icon id="btn_print_factura" src="../images/wired-lineal-732-printer.json" trigger="hover"
                    style="width:70px;height:70px" class="svg disk_save botonera " data-bs-toggle="tooltip"
                    data-bs-placement="top" title="Imprimir">
                </lord-icon>
            </div>
            <div id="div_anular">
                <lord-icon id="btn_anular_factura" src="../images/wired-lineal-38-error-cross-simple.json" trigger="hover"
                    style="width:70px;height:70px" class="svg disk_save botonera " data-bs-toggle="tooltip"
                    data-bs-placement="top" title="Anular">
                </lord-icon>
            </div>
            <div id="div_regresar">
                <lord-icon id="btn_regresar" src="../images/wired-lineal-31-chevron-right.json" trigger="hover"
                    style="width:70px;height:70px;transform: rotate(180deg);" class="svg disk_save botonera " data-bs-toggle="tooltip"
                    data-bs-placement="top" title="Volver">
                </lord-icon>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modal_admisiones" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="exampleModalLabel">Seleccione Pacientes</h1>
                    <button type="button" class="btn-close cerrar_list" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="filtros_div">
                        <div class="div1 row">
                            <div class="col">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="tipo_admision" id="inp_part" value="P" >
                                    <label class="form-check-label" for="inp_part">
                                        Particulares
                                    </label>
                                </div>
                                <div class="form-check"id=div_inp_inter>
                                    <input class="form-check-input" type="radio" name="tipo_admision" id="inp_inter" value="I">
                                    <label class="form-check-label" for="inp_inter">
                                        Internos
                                    </label>
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-check" id=div_inp_seg>
                                    <input class="form-check-input" type="radio" name="tipo_admision" id="inp_seg" value="S">
                                    <label class="form-check-label" for="inp_seg">
                                        Seguros
                                    </label>
                                </div>
                                <div class="form-check" id=div_inp_emp>
                                    <input class="form-check-input" type="radio" name="tipo_admision" id="inp_emp" value="E">
                                    <label class="form-check-label" for="inp_emp">
                                        Empresas
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="div2">
                            <select class="form-select form-select-lg mb-3" aria-label="empresas o seguros" id="empre-seg" disabled>
                            </select>
                            <select class="form-select form-select-lg mb-3 d-none" aria-label="sub-empresa" id="sub_empresa">
                            </select>
                        </div>
                    </div>
                    <div class="tabla-admisiones">
                        <table id="tabla-admisiones"></table>
                    </div>
                    
                </div>

                <div class="modal-footer row">
                    <div class="row justify-content-between">
                        <div class="col">
                            <h4>Monto a facturar Bs. <span class=sumatoria>0,00</span></h4>
                        </div>
                        <div class="col text-end">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="cerrar_lista">Cerrar</button>
                            <button type="button" class="btn btn-primary" data-bs-dismiss="modal" id="aceptar_lista">Aceptar</button>
                        </div>
                    </div>
                    

                </div>
            </div>
        </div>
    </div>
    
</body>
</html>
<script>
    //const HOST = "https://facturacion.siac.historiaclinica.org";
    const HOST = "http://localhost:3001";
    const id_cli = 3;
    let detalles = [];

document.getElementById("chk_contado").addEventListener("change", function() {
        
        if (this.checked) {
            document.querySelector(".row_credito").classList.add('d-none');            
        } else {
            document.querySelector(".row_credito").classList.remove('d-none');
        }
    });
    
async function cargar_tipo(tipo, select = document.getElementById("empre-seg"), subemp=null ){
    Swal.fire({
        title: `Espere mientras carga la data de Seguro/empresa/interno`,
        icon: 'info',
        allowOutsideClick: () => false,
    }); 
    Swal.showLoading()
    var url = `${HOST}/api/tipo_admision/?tipo=${tipo}&clinic_id=${id_cli}&subemp=${subemp}`;
    try {
        let parroquias = await fetch(url);
        const data = await parroquias.json();
        
        if (data.error || isNaN(data.length)) { 
            Swal.close();
            select.innerHTML = "";
            select.classList.add('d-none');
            
        } else {
            select.innerHTML = "";
            select.classList.remove('d-none');
                const option = document.createElement("option");
                option.value = "";
                option.textContent = "Seleccione...";                                
                select.appendChild(option);
            data.forEach(parroquia => {
                const option = document.createElement("option");
                option.value = parroquia[Object.keys(parroquia)[0]];
                option.textContent = decodeHtml(parroquia[Object.keys(parroquia)[1]]);                                
                select.appendChild(option);
            });
            Swal.close()
        }
        
        } catch (error) {
            console.log(error)
        } 
}

function decodeHtml(html) {
    const txt = document.createElement("textarea");
    txt.innerHTML = html;
    return txt.value;
}

document.querySelectorAll('input[name="tipo_admision"]').forEach((radio) => {
    radio.addEventListener('change', function () {
        document.getElementById("tabla-admisiones").innerHTML = '';
        document.querySelector(".sumatoria").innerText = "0,00"
        if (this.checked) {
            switch (this.value) {
                case "E":
                    document.getElementById('empre-seg').disabled = false;
                    document.getElementById('empre-seg').classList.remove('d-none');
                    document.getElementById('sub_empresa').classList.add('d-none');
                    document.getElementById('sub_empresa').innerHTML= "";
                    cargar_tipo(this.value);                    
                    break;
                case "S":
                    document.getElementById('empre-seg').disabled = false;
                    document.getElementById('empre-seg').classList.remove('d-none');
                    document.getElementById('sub_empresa').classList.add('d-none');
                    document.getElementById('empre-seg').innerHTML= "";
                    cargar_tipo(this.value);
                    break;
                case "I":
                    document.getElementById('empre-seg').disabled = false;
                    document.getElementById('empre-seg').classList.remove('d-none');
                    document.getElementById('sub_empresa').classList.add('d-none');
                    document.getElementById('empre-seg').innerHTML= "";
                    cargar_tipo(this.value);
                    break;                                    
                default:
                    document.getElementById('empre-seg').disabled = true;
                    document.getElementById('empre-seg').classList.remove('d-none');
                    document.getElementById('sub_empresa').classList.add('d-none');
                    document.getElementById('empre-seg').innerHTML= "";
                    fetchAdmisiones(1,1000,'P')
                    break;
            }
       }
    });
});

document.getElementById('empre-seg').addEventListener('change', function () {
    document.querySelectorAll('input[name="tipo_admision"]').forEach((radio) => {        
        if(radio.checked){
            fetchAdmisiones(1,1000,radio.value)
            if(radio.value =='E'){
                cargar_tipo('sub',document.getElementById('sub_empresa'),this.value);
                return;
            }            
        }
    })
})

async function fetchAdmisiones(pagina = 1, porPagina = 1000, tipos) {
    
    document.querySelector(".sumatoria").innerText = "0,00";
    document.getElementById("tabla-admisiones").innerHTML = '';
    try {
        document.getElementById("tabla-admisiones").innerHTML =
        '<tr><td colspan="3" class="text-center">Cargando...</td></tr>';
        const fechaInicio = '2024-01-01'; // fecha anterior al inicio del sistema
        const fechaFin = new Date().toISOString().split('T')[0];
        const activos =[1];
        const agrupado = "s";
        // Obtener tipos de consulta seleccionados
        const tiposConsulta = [];

        if (tipos == 'sub'){
            tiposConsulta.push('E');
        }else{
            tiposConsulta.push(tipos);    
        }
        
        Swal.fire({
        title: "Generando la data",
        allowOutsideClick: () => false,
        });
        Swal.showLoading();
        const response = await fetch(`${HOST}/admisiones_admidet`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
        },
        body: JSON.stringify({
            id_cli: id_cli,
            status_cierre: "abiertas",
            fecha_inicio: fechaInicio,
            fecha_fin: fechaFin,
            tipos_consulta: tiposConsulta,
            activos: activos,
            page: pagina,
            perPage: porPagina,
            agrupado: agrupado,
        }),
        });

        if (!response.ok) {
        throw new Error("Error al obtener admisiones");
        }

        const data = await response.json();
        Swal.close();

        mostrarResultados(data, tipos);

    } catch (error) {
        Swal.fire({
        title: "Error",
        text: error,
        icon: "error",
        allowOutsideClick: () => false,
        });
        Swal.hideLoading();
        
        document.getElementById("tabla-admisiones").innerHTML =
        '<tr><td colspan="3" class="text-center text-danger">Error al cargar los datos</td></tr>';
    }
}

function mostrarResultados(data, tipos){
    
    const tabla = document.getElementById("tabla-admisiones");
    tabla.classList.add("table")
    tabla.classList.add("table-striped")
    tabla.classList.add("table-hover")
        tabla.innerHTML = ""; // Limpiar tabla

        if (
          !data.resultados ||
          data.resultados.error ||
          data.resultados.length === 0
        ) {
          const fila = document.createElement("tr");
          fila.innerHTML =
            '<td colspan="10" class="text-center">No hay registros que mostrar</td>';
          tabla.appendChild(fila);
            return;
        }

          const thead = document.createElement("thead");
        thead.innerHTML = `           
                <th>Selec.</th>
                <th>Ced.Pac.</th>
                <th>Paciente</th>
                <th>Titular</th>
                <th>Clave</th>
                <th class="text-end text-nowrap">Precio Bs</th>
                <th>Fecha</th>
        `;
        
        tabla.appendChild(thead);
        thead.classList.add("table-dark");
        const tbody = document.createElement("tbody");
        
        switch (tipos) {
            case 'S':
                data.resultados = data.resultados.filter(admision => admision.id_seguro == document.getElementById('empre-seg').value);
                break;
            case 'E':
                data.resultados = data.resultados.filter(admision => admision.id_empresa == document.getElementById('empre-seg').value);
                break;
            case 'I':
                data.resultados = data.resultados.filter(admision => admision.id_tipo_interno == document.getElementById('empre-seg').value);
                break;
            case 'sub':
                data.resultados = data.resultados.filter(admision => admision.id_subempresa == document.getElementById('sub_empresa').value);
                break;
            default:
                break;
        }

        if (data.resultados.length ===0){
          const fila = document.createElement("tr");
          fila.innerHTML =
            '<td></td><td></td><td></td><td class="text-center">No hay registros que mostrar</td><td></td><td></td><td></td>';
          tabla.appendChild(fila);
          
            return;
        }        

        data.resultados.forEach((admision) => {

            const fila = document.createElement("tr");

            // Oculta las admisiones que son presupuestos
            fila.className = `${
                admision.solo_ppto == 1 ? "d-none" : ""
            }`;

            // Formatear fecha dd/mm/yyyy
            const fechaAdmision = new Date(admision.fecha_admision);
            const fechaFormateada = `${fechaAdmision
            .getDate()
            .toString()
            .padStart(2, "0")}/${(fechaAdmision.getMonth() + 1)
            .toString()
            .padStart(2, "0")}/${fechaAdmision.getFullYear()}`;
            // Formatear montos
            const precioBs = parseFloat(admision.precio || 0).toFixed(2);

            let switch_admision =`<div class='form-check form-switch'>
                                    <input class='form-check-input admisiones admisiones_switch'
                                    data-paciente='${admision.nombre_completo_paciente}'
                                    data-cedula='${admision.cedula_paciente}'
                                    data-titular='${admision.nombre_completo_titular}'
                                    data-cedtitular='${admision.cedula_titular}'
                                    data-tasa='${admision.tasa}'
                                    data-monto='${precioBs}'
                                    type='checkbox' role='switch' id='admision${admision.id_admision}'  
                                value='${admision.id_admision}'></div>`;
            
            fila.innerHTML = `
                <td>${switch_admision}</td>
                <td class="text-nowrap">${admision.cedula_paciente}</td>
                <td>${admision.nombre_completo_paciente}</td>
                <td>${admision.nombre_completo_titular}</td>
                <td>${admision.clave || ""}</td>
                <td class="text-nowrap text-end">Bs ${precioBs}</td>                
                <td>${fechaFormateada}</td>`;
            tbody.appendChild(fila);
            });
        
        tabla.appendChild(tbody);

        var switches = document.querySelectorAll('.admisiones_switch')
        var monto_total = 0;
        switches.forEach(switch_inp=>{            
            switch_inp.addEventListener('click', function(){
                const totalSum = Array.from(document.querySelectorAll('.admisiones_switch:checked'))
                .reduce((sum, switchElement) => sum + parseFloat(switchElement.getAttribute('data-monto')), 0);
                document.querySelector(".sumatoria").innerText = totalSum.toFixed(2)
            // document.getElementById('row_'+switch_inp.id).remove()
            })
        })
    
}

document.getElementById('sub_empresa').addEventListener('change', function () {
    if (this.value == "") {
        fetchAdmisiones(1,1000,'E', document.getElementById('empre-seg').value)
    }else{
        fetchAdmisiones(1,1000,'sub', this.value)
    }
    
})

document.getElementById('aceptar_lista').addEventListener('click', function () {
    const selectedAdmisiones = Array.from(document.querySelectorAll('.admisiones_switch:checked'));
    const selectedIds = selectedAdmisiones.map(admision => admision.value);
    const selectedPacientes = selectedAdmisiones.map(admision => admision.getAttribute('data-paciente'));
    const selectedCedulas = selectedAdmisiones.map(admision => admision.getAttribute('data-cedula'));
    const selectedTitulares = selectedAdmisiones.map(admision => admision.getAttribute('data-titular'));
    const selectedCedTitulars = selectedAdmisiones.map(admision => admision.getAttribute('data-cedtitular'));
    const selectedMontos = selectedAdmisiones.map(admision => admision.getAttribute('data-monto'));
    const selectedTasa = selectedAdmisiones.map(admision => admision.getAttribute('data-tasa'));
    fetchDetalles(selectedIds)
    
})

async function fetchDetalles(admisiones) {    
    if(admisiones.length == 0){
        Swal.fire({
            title: "Error",
            text: "No hay admisiones seleccionadas",
            icon: "error",
            allowOutsideClick: () => false,
        });
        return;
    }
    try {
                        
        Swal.fire({
            title: "Generando la data",
            allowOutsideClick: () => false,
        });
        
        Swal.showLoading();
        const response = await fetch(`${HOST}/detalles_admision`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                admisiones: admisiones
            }),
        });

        if (!response.ok) {
        throw new Error("Error al obtener admisiones");
        }

        const data = await response.json();
        Swal.close();

        detalles = data.resultados.map((detalle) => {
            return {
                id_admision: detalle.id_admision,
                id_detalle: detalle.id_admidet,
                grupo: detalle.grupo_estudio,
                tipo: detalle.tipo_estudio,
                direccion: detalle.direccion,
                direccion_join: detalle.empresa_direccion || detalle.seguro_direccion,
                precio: detalle.precio,
                rif: detalle.empresa_rif || detalle.seguro_rif ||detalle.cedula_titular,
                precio_usd: detalle.precio_usd,
                precio_usd_cant: Number(detalle.precio_usd)*Number(detalle.cantidad),
                precio_bs_cant: Number(detalle.precio)*Number(detalle.cantidad),
                cantidad: detalle.cantidad,                
                cedula_paciente: detalle.cedula_paciente,
                nombre_paciente: detalle.nombre_completo_paciente,
                cedula_titular: detalle.cedula_titular.trim(), 
                nombre_titular: detalle.nombre_completo_titular,
                seguro_empresa:detalle.empresa || detalle.seguro,
                tasa: detalle.tasa,
                estudio: detalle.estudio,
                impuesto: detalle.impuesto
            };
        });
        //ordenamos los detalles para que el primero sea el mas reciente
        detalles.sort((a, b) => {
            const idA = Number(a.id_admision);
            const idB = Number(b.id_admision);

            if (idA < idB) return 1; 
            if (idA > idB) return -1;
            return 0; 
        });
        
        document.getElementById("dir_fiscal").value = detalles[0].direccion_join || detalles[0].direccion;
        document.getElementById("rif").value = detalles[0].rif.trim() || detalles[0].cedula_titular.trim() ||detalles[0].cedula_paciente.trim();
        document.getElementById("razon_social").value = detalles[0].seguro_empresa || detalles[0].nombre_titular.trim() || detalles[0].nombre_paciente.trim();
       
        const pacientes = detalles.map(detalle => detalle.nombre_paciente);
        const uniquePacientes = [...new Set(pacientes)];

        const primerosCinco = uniquePacientes.slice(0, 5).join(", ");
        const resto = uniquePacientes.length > 5 ? "..." : "";
        document.getElementById("pacientes").value = `${primerosCinco} ${resto}`;
        document.getElementById("pacientes").style.height = "33px";
        if(uniquePacientes.length >3){
            document.getElementById("pacientes").style.height = "auto";
        }
        const tasas = detalles.map(detalle => detalle.tasa);
        const uniqueTasa = [...new Set(tasas)];
        if(uniqueTasa.length > 1){
            document.getElementById('tasa_admi').textContent = "Tasas varias";
        }else{
            document.getElementById('tasa_admi').textContent = uniqueTasa[0];
        }

        const tipoAgrupamiento = document.querySelector('input[name="rad_tipo_agrupamiento"]:checked').value; 

        const table = document.getElementById("table_detalle");
        table.innerHTML = ""; // Limpiar tabla  
        const thead = document.createElement("thead");
        thead.innerHTML = `
            <tr>
            <th>Descripcion</th>
            <th class="text-center">Cantidad</th>
            <th class="text-end">Precio</th>
            <th class="text-end">Precio USD</th>
            <th class="text-center">Impuesto</th>
            </tr>
        `;
        table.appendChild(thead);

        const tbody = document.createElement("tbody");
        
        switch (tipoAgrupamiento) {
            case "tipo":
                agruparPorTipo(detalles)
                break;
        
            default:
                break;
        }
        detalles.forEach(detalle => {
            const row = document.createElement("tr");
            row.innerHTML = `
            <td>${detalle.estudio}</td>
            <td class="text-center">${detalle.cantidad}</td>
            <td class="text-end">${Number(Number(detalle.precio).toFixed(2)*Number(detalle.cantidad).toFixed(2)).toFixed(2)}</td>
            <td class="text-end">${Number(Number(detalle.precio_usd).toFixed(2)*Number(detalle.cantidad).toFixed(2)).toFixed(2)}</td>
            <td class="text-center">${(Number(detalle.impuesto).toFixed(2)==0.00)?"E":Number(detalle.impuesto).toFixed(2)}</td>
            `;
            tbody.appendChild(row);
        });
        
        table.appendChild(tbody);
    
        console.log(detalles)
    } catch (error) {
        Swal.fire({
        title: "Error",
        text: error,
        icon: "error",
        allowOutsideClick: () => false,
        });
        Swal.hideLoading();
    }
}

function agruparPorTipo(data) {
    const resultado = {};

    data.forEach(item => {
        const tipo = item.tipo;

        // Si el tipo no existe en el resultado, inicializamos su estructura
        if (!resultado[tipo]) {
            resultado[tipo] = {
                tipo: tipo,
                cantidad_total: 0,
                precio_total: 0,
                precio_usd_total: 0,
                impuesto_total: 0,
                detalles: []
            };
        }

        // Sumamos los valores correspondientes
        resultado[tipo].cantidad_total += item.cantidad;
        resultado[tipo].precio_total += parseFloat(item.precio);
        resultado[tipo].precio_usd_total += parseFloat(item.precio_usd);
        resultado[tipo].impuesto_total += parseFloat(item.impuesto);

        // Agregamos el detalle del registro al grupo
        resultado[tipo].detalles.push({
            id_admision: item.id_admision,
            id_detalle: item.id_detalle,
            estudio: item.estudio,
            precio: parseFloat(item.precio),
            precio_usd: parseFloat(item.precio_usd),
            cantidad: item.cantidad,
            impuesto: parseFloat(item.impuesto)
        });
    });

    // Convertimos el objeto a un array para facilitar su uso
    return Object.values(resultado);
}


</script>