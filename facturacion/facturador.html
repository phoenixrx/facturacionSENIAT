<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facturas - SIAC</title>
    <link rel="icon" type="image/x-icon" href="https://siac.empresas.historiaclinica.org/images/Imagen1.ico">
    <script src="https://siac.empresas.historiaclinica.org/js/sweetalert2.all.min.js"></script>
    <link href="https://siac.empresas.historiaclinica.org/css/sweetalert2.min.css" rel="stylesheet" />
    <script src="https://siac.empresas.historiaclinica.org/js/bootstrap.bundle.min.js"></script>
    <link href="https://siac.empresas.historiaclinica.org/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://siac.empresas.historiaclinica.org/js/jquery-3.7.1.js"></script>
    <script src="https://siac.empresas.historiaclinica.org/js/lordicon.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
</head>
<style>
    .div1 {
        grid-area: 1 / 1 / 2 / 2;
    }

    .div2 {
        grid-area: 1 / 2 / 2 / 4;
    }
    .filtros_div {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        grid-template-rows: 1fr;
        grid-column-gap: 0px;
        grid-row-gap: 0px;
    }
    input[readonly] {
        background-color: #f0f0f0;
        border: 1px solid #ccc;
        color: #333;
    }
    textarea[readonly] {
        background-color: #f0f0f0;
        border: 1px solid #ccc;
        color: #333;
    }
    input[type="text"] {
        width: 100%;
        padding: 2px;
        border-radius: 4px;
        border: 1px solid #ccc;
    }
    textarea {
        width: 100%;
        padding: 2px;
        height: 68px;
        border-radius: 4px;
        border: 1px solid #ccc;
    }
    
    @media (min-width: 576px) {
        .modal-dialog {
            max-width: 800px !important;
            margin: 1.75rem auto;
        }
    }
</style>
<body>
    <div class="container">        
        <h2>Facturaci贸n SIAC</h2>
        <div class="row">
            <div class="col-8 rounded-1 border border-1 border-info-subtle">
                <div class="row mb-1 mt-1">
                    <div class="col-2"><span>RIF</span></div>
                    <div class="col-10"><input type="text" readonly/> </div>
                </div>
                <div class="row ">
                    <div class="col-2"><span>Direcci贸n Fiscal</span></div>
                    <div class="col-10"><textarea readonly></textarea> </div>
                </div>
                <div class="row mb-1">
                    <div class="col-2"><span>Paciente(s)</span></div>
                    <div class="col-10"><input type="text" readonly/> </div>
                </div>
                <div class="row mb-1">
                    <div class="col-2"><span>Rep./Tit.</span></div>
                    <div class="col-10"><input type="text" readonly/> </div>
                </div>
            </div>
            <div class="col-4 rounded-1 border border-1 border-info-subtle">
                <div class="row mb-1 mt-1">
                    <div class="col-5 text-end"><span>Control</span></div>
                    <div class="col-7"><input type="text" readonly/> </div>
                </div>
                <div class="row mb-1">
                    <div class="col-5 text-end"><span>Factura</span></div>
                    <div class="col-7"><input type="text" readonly/> </div>
                </div>
                <div class="row mb-1">
                    <div class="col-5 text-end"><span>F. Atenci贸n</span></div>
                    <div class="col-7"><input type="text" readonly/> </div>
                </div>
                <div class="row mb-1">
                    <div class="col-5 text-end"><span>F. Emisi贸n</span></div>
                    <div class="col-7"><input type="text" readonly/> </div>
                </div>
                <div class="row mb-1">
                    <div class="col-5 text-end"><span>Formato</span></div>
                    <div class="col-7"><input type="text" readonly/> </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="mt-1 mb-1">   
                <div class="btn-group w-100 " role="group" aria-label="Tipo de factura" data-bs-toggle="tooltip"
                    data-bs-placement="top" title="Formato de agrupacion">
                    <input type="radio" class="btn-check" name=rad_tipo_agrupamiento id="btn_detalle_agrupado"  value="agrupada">
                    <label class="btn btn-outline-primary" for="btn_detalle_agrupado">Por grupo</label>
                    <input type="radio" class="btn-check" name=rad_tipo_agrupamiento id="btn_detalle_tipo"  value="tipo">
                    <label class="btn btn-outline-primary" for="btn_detalle_agrupado">Por tipo</label>
                    <input type="radio" class="btn-check" name=rad_tipo_agrupamiento id="btn_detalle_detallado" value="detallada" checked>
                    <label class="btn btn-outline-primary" for="btn_detalle_detallado">Detallada</label>
                    <input type="radio" class="btn-check" name=rad_tipo_agrupamiento id="btn_detalle_porcentual" value="porcentual">
                    <label class="btn btn-outline-primary" for="btn_detalle_porcentual">Porcentual</label>
                </div>
            </div>
            <table class="table table-striped" id="table_detalle"></table>
        </div>
        <div class="row ">
            <div class="col-6">
                <div class="form-floating row">
                    <textarea class="form-control" placeholder="Nota" id="nota"></textarea>
                    <label for="nota">Nota</label>
                </div>
                <div class="row">
                    <div class="form-check form-switch">
                        <input class="form-check-input tasa_chk" type="radio" id="chk_tasa_admision" name='tasa_chk' data-tasa="0.00" checked>
                        <label class="form-check-label" for="chk_tasa_admision">Tasa Admision (<span class="tasa_admi"></span>)</label>
                    </div>
                    <div class="form-check form-switch tasa_chk">
                        <input class="form-check-input " type="radio" id="chk_tasa_actual" name='tasa_chk' >
                        <label class="form-check-label" for="chk_tasa_actual">Tasa Actual</label>
                    </div>
                    <div class="form-check form-switch  tasa_chk">
                        <input class="form-check-input " type="checkbox" id="chk_contado" name='contado' checked>
                        <label class="form-check-label" for="chk_contado">Pago Contado</label>
                    </div>
                    <div class="row row_credito mt-1 d-none">
                        <input type="hidden" id=moneda_credito>
                        <input type="hidden" id=monto_credito>
                        <div class="form-floating col-8">
                            <input type="date" name="fecha_vencimiento" id="fecha_vencimiento"
                            class="fecha_vencimiento form-control form-date border border-primary-subtle" 
                            value='' min='2024-11-01'/>
                            <label for="fecha_vencimiento">Fecha Vencimiento</label>
                        </div>
                        <div class="form-floating col-4 ">
                            <input type="text" class="form-control text-center border border-primary-subtle" 
                            id=cuotas
                            value="" maxlength="2">
                            <label for="cuotas">Cuotas</label>
                            <script>                                               
                                $("#cuotas").on("input", function () {
                                    this.value = this.value.replace(/[^0-9]/g, "").replace(/,/g, ".");
                                });
                            </script>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-6">
                <div class="row">
                    <div class="col-4 text-end"><span>Exento: </span></div>
                    <div class="col-8"><input type="text" readonly/></div>
                </div>
                <div class="row">
                    <div class="col-4 text-end"><span>BI 16:</span></div>
                    <div class="col-8"><input type="text" readonly/></div>
                </div>
                <div class="row">
                    <div class="col-4 text-end"><span>IGFT:</span></div>
                    <div class="col-8"><input type="text" readonly/></div>
                </div>
                <div class="row">
                    <div class="col-4 text-end"><span>IVA(16)</span></div>
                    <div class="col-8"><input type="text" readonly/></div>
                </div>
                <div class="row">
                    <div class="col-4 text-end"><span>Total:</span></div>
                    <div class="col-8"><input type="text" readonly/></div>
                </div>
            </div>
        </div>
        <div class="botonera d-flex justify-content-center align-items-center flex-row">
            
            <div data-bs-toggle="modal" data-bs-target="#modal_admisiones" id="agregar_admi">
                <lord-icon src="../images/wired-lineal-48-plus-to-square-rotation.json"
                    trigger="hover" style="width:70px;height:70px" class="svg disk_save  botonera" data-bs-toggle="tooltip"
                    data-bs-placement="top" title="Agregar admisiones" data-bs-toggle="modal" data-bs-target="#staticBackdrop">
                </lord-icon>
    
            </div>
    
            <div id="div_fact_factura">
                <lord-icon id="btn_fact_factura" src="../images/wired-lineal-1374-cash-register-messenger.json"
                    trigger="hover" style="width:70px;height:70px" class="svg disk_save  botonera" data-bs-toggle="tooltip"
                    data-bs-placement="top" title="Factura" data-bs-toggle="modal" data-bs-target="#staticBackdrop">
                </lord-icon>
            </div>
            <div id="div_fact_presup">
                <lord-icon id="btn_presup_factura" src="../images/wired-lineal-987-accounting.json" trigger="hover"
                    style="width:70px;height:70px" class="svg disk_save  botonera" data-bs-toggle="tooltip"
                    data-bs-placement="top" title="Presupuesto">
                </lord-icon>
            </div>
            <div id="div_imprimir">
                <lord-icon id="btn_print_factura" src="../images/wired-lineal-732-printer.json" trigger="hover"
                    style="width:70px;height:70px" class="svg disk_save botonera " data-bs-toggle="tooltip"
                    data-bs-placement="top" title="Imprimir">
                </lord-icon>
            </div>
            <div id="div_anular">
                <lord-icon id="btn_anular_factura" src="../images/wired-lineal-38-error-cross-simple.json" trigger="hover"
                    style="width:70px;height:70px" class="svg disk_save botonera " data-bs-toggle="tooltip"
                    data-bs-placement="top" title="Anular">
                </lord-icon>
            </div>
            <div id="div_regresar">
                <lord-icon id="btn_regresar" src="../images/wired-lineal-31-chevron-right.json" trigger="hover"
                    style="width:70px;height:70px;transform: rotate(180deg);" class="svg disk_save botonera " data-bs-toggle="tooltip"
                    data-bs-placement="top" title="Volver">
                </lord-icon>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modal_admisiones" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="exampleModalLabel">Seleccione Pacientes</h1>
                    <button type="button" class="btn-close cerrar_list" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="filtros_div">
                        <div class="div1 row">
                            <div class="col">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="flexRadioDefault" id="inp_part" checked>
                                    <label class="form-check-label" for="inp_part">
                                        Particulares
                                    </label>
                                </div>
                                <div class="form-check"id=div_inp_inter>
                                    <input class="form-check-input" type="radio" name="flexRadioDefault" id="inp_inter">
                                    <label class="form-check-label" for="inp_inter">
                                        Internos
                                    </label>
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-check" id=div_inp_seg>
                                    <input class="form-check-input" type="radio" name="flexRadioDefault" id="inp_seg">
                                    <label class="form-check-label" for="inp_seg">
                                        Seguros
                                    </label>
                                </div>
                                <div class="form-check" id=div_inp_emp>
                                    <input class="form-check-input" type="radio" name="flexRadioDefault" id="inp_emp">
                                    <label class="form-check-label" for="inp_emp">
                                        Empresas
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="div2">
                            <select class="form-select form-select-lg mb-3" aria-label="empresas o seguros" id="empre-seg" disabled>
                            </select>
                            <select class="form-select form-select-lg mb-3 d-none" aria-label="sub-empresa" id="sub_empresa">
                            </select>
                        </div>
                    </div>
                    <div id="detallado">

                    </div>
                    
                </div>

                <div class="modal-footer row">
                    <div class="row justify-content-between">
                        <div class="col">
                            <h4>Monto seleccionado Bs. <span class=sumatoria>0,00</span></h4>
                        </div>
                        <div class="col">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="cerrar_lista">Cerrar</button>
                            <button type="button" class="btn btn-primary" data-bs-dismiss="modal" id="aceptar_lista">Aceptar</button>
                        </div>
                    </div>
                    

                </div>
            </div>
        </div>
    </div>
    
</body>
</html>
<script>
    //const HOST = "https://facturacion.siac.historiaclinica.org";
    const HOST = "http://localhost:3001";
    const id_cli = 3;

    document.getElementById("chk_contado").addEventListener("change", function() {
        
        if (this.checked) {
            document.querySelector(".row_credito").classList.add('d-none');            
        } else {
            document.querySelector(".row_credito").classList.remove('d-none');
        }
    });
    document.getElementById('inp_part').addEventListener('change', function () {
        document.getElementById('empre-seg').value = '';
        document.getElementById('sub_empresa').value = "";
        document.getElementById('empre-seg').disabled =this.checked;
        if(this.checked){
            document.getElementById('sub_empresa').classList.add('d-none');
        }else{
            document.getElementById('sub_empresa').classList.remove('d-none');
        }
    })
    async function cargar_tipo(tipo){
    Swal.fire({
        title: `Espere mientras carga la data de Seguro/empresa/interno`,
        icon: 'info',
        allowOutsideClick: () => false,
    }); 
    Swal.showLoading()
    var url = `${HOST}/api/tipo_admision/?tipo=${tipo}&clinic_id=${id_cli}`;
    try {
        let parroquias = await fetch(url);
        const data = await parroquias.json();
        
        if (data.error || isNaN(data.length)) { // paciente no encontrado, registrarlo
            Swal.update({
                title: `Error al obtener los datos ${tipo}`,
                icon: 'error',
                allowOutsideClick: () => false,
            });            
        } else {
            const select = document.getElementById("empre-seg");
            data.forEach(parroquia => {
                const option = document.createElement("option");
                option.value = parroquia[Object.keys(parroquia)[0]];
                option.textContent = decodeHtml(parroquia[Object.keys(parroquia)[1]]);
                                
                select.appendChild(option);
            });
            Swal.close()
        }
        
        } catch (error) {
            console.log(error)
        } 
}
cargar_tipo('S')
function decodeHtml(html) {
    const txt = document.createElement("textarea");
    txt.innerHTML = html;
    return txt.value;
}
</script>